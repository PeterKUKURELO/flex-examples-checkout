<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pay-me Flex | Simple</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">


  <style>
    :root{
      --bg:#f7faf8;
      --panel:#ffffff;
       --background:
    radial-gradient(900px circle at 18% 12%, rgba(106,161,137,.16) 0%, transparent 58%),
    radial-gradient(1100px circle at 82% 18%, rgba(106,161,137,.10) 0%, transparent 62%),
    linear-gradient(180deg, #f9fbfa 0%, #eef4f1 55%, #e7efe9 100%);
      --border:#dbe7e1;
      --muted:#5c6f67;
      --text:#0f1613;
      --btn:#6aa189;

      --background-alternate:
  radial-gradient(900px circle at 18% 12%, rgba(106,161,137,.18) 0%, transparent 62%),
  radial-gradient(1100px circle at 82% 18%, rgba(106,161,137,.12) 0%, transparent 64%),
  linear-gradient(180deg, #f5f9f7 0%, #e9f1ed 55%, #e3ede7 100%);


      --accent:#6aa189;


      /* bordes “harmonizados” (verde + transparencia) */
      --sb-border: rgba(106,161,137,.28);
      --sb-border-strong: rgba(106,161,137,.45);

      /* texto sobre fondo oscuro */
      --sb-text: #0f1613;
      --sb-muted: #50625b;

      /* campos */
      --sb-field-bg: #ffffff;
      --sb-field-text: #0f1613;

    }

    *{ box-sizing:border-box; }
    body{
      font-family: Arial, sans-serif;
      background:var(--background-alternate);
      margin:0;
      color:var(--text);
       font-family: "Roboto", sans-serif;
      font-optical-sizing: auto;
      font-weight: 400;
      font-style: normal;
      font-variation-settings:
        "wdth" 100;
    }

    /* Layout */
    .app{
      display:flex;
      min-height:100vh;
      width:100%;
    }

    .sidebar{
      width: 360px;
      background:var(--panel);
      border-right: 1px solid var(--sb-border);
      box-shadow: inset -1px 0 0 rgba(0,0,0,.35);
      padding:18px;
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
    }

    .content{
      flex:1;
      padding:24px;
      min-width: 0;
    }

    /* Sidebar header + nav (similar a tu imagen) */
    .sidebarTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
      border-bottom: 1px solid var(--sb-border);
    }
    .sidebarTitle{
      font-size:13px;
      font-weight:700;
      color: var(--sb-text);
      letter-spacing:.2px;
    }

    /* 3) Labels / hints con armonía */
    .sidebar label{ color: var(--sb-text); }
    .sidebar .hint{ color: var(--sb-muted); }

    /* 4) Inputs/select con borde verdoso “exacto/parecido” al fondo */
    .sidebar input,
    .sidebar select{
      background: var(--sb-field-bg);
      color: var(--sb-field-text);
      border: 1px solid var(--sb-border);
    }

    .sidebar input:hover,
    .sidebar select:hover{
      border-color: var(--sb-border-strong);
    }

    .sidebar input:focus,
    .sidebar select:focus{
      border-color: rgba(106,161,137,.70);
      box-shadow: 0 0 0 3px rgba(106,161,137,.22);
    }

    /* 5) Botones (manteniendo tu estilo) */
    .sidebar button{
      border: 1px solid var(--sb-border);
      background: rgba(255,255,255,.92);
    }

    .sidebar .btnSecondary{
      background: rgba(106,161,137,.18);
      border-color: var(--sb-border);
      color: var(--text);
    }

    /* 6) Banner con borde a juego (opcional) */
    .sidebarFooter img{
      border: 1px solid var(--sb-border);
    }

    .collapseBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
    }

    .nav{
      margin:10px 0 16px;
      padding:0;
      list-style:none;
    }
    .nav li{ margin:4px 0; }
    .nav a{
      display:flex;
      gap:10px;
      align-items:center;
      text-decoration:none;
      color:var(--text);
      padding:10px 10px;
      border-radius:10px;
    }
    .nav a:hover{ background:#f3f4f6; }
    .nav .dot{
      width:18px;height:18px;
      border:1px solid var(--border);
      border-radius:6px;
      display:inline-block;
      background:#fff;
    }

    /* Form styles (tu card ahora dentro del sidebar) */
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
    }

    /* En sidebar mejor 1 columna */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    label{
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 6px;
      display:block;
    }
    input, select{
      width:100%;
      padding:10px 12px;
      border:1px solid #ddd;
      border-radius:10px;
      font-size:14px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    button{
      padding:12px 14px;
      border:0;
      border-radius:10px;
      background:var(--btn);
      color:#fff;
      font-weight:800;
      cursor:pointer;
    }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .hint{ font-size: 12px; color:#555; margin-top:6px; }
    #status{ font-weight:700; }

    /* Main panel */
    .mainCard{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:18px;
      max-width: 980px;
    }

    #flexMount{ margin-top: 14px; }

    pre{
      margin-top: 14px;
      background:#0b1020;
      color:#e7e7e7;
      padding:12px;
      border-radius:10px;
      overflow:auto;
      max-height: 420px;
    }

    .sidebar{
  width:360px;
  background:var(--background);
  border-right:1px solid var(--border);
  padding:16px;
  position:sticky;
  top:0;
  height:100vh;
  overflow:auto;
}

.sidebarTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding-bottom:12px;
  margin-bottom:12px;
  border-bottom:1px solid var(--border);
}

.sidebarTitle{
  font-size:17px;
  font-weight:800;
  color:var(--text);
}

.sidebarCard{
  padding: 12px;
  border-radius: 16px;
  border: 1px solid rgba(106,161,137,.18);
  background: rgba(255,255,255,.78);
  backdrop-filter: blur(6px);
}

.sidebarFooter img {
  border-radius: 23px;
}
.grid{
  display:grid;
  grid-template-columns: 1fr;
  gap:12px;
}

label{
  display:block;
  font-size:14px;
  font-weight:800;
  color:var(--text);
  margin-bottom:6px;
}

input, select{
  width:100%;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  font-size:14px;
  outline:none;
}

input:focus, select:focus{
  border-color:#cbd5e1;
  box-shadow:0 0 0 3px rgba(148,163,184,.25);
}

.hint{
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
}

.row{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-top:14px;
}

button{
  padding:11px 14px;
  border:0;
  border-radius:12px;
  background:var(--panel);
  color:var(--text);
  font-weight:900;
  cursor:pointer;
}

button:disabled{
  opacity:.6;
  cursor:not-allowed;
}

.btnSecondary{
  background: rgba(106,161,137,.14);
  color: var(--text);
}

.status{
  font-weight:800;
  color:var(--text);
  display: inline-flex;
  align-items: center;
  gap: 10px;
}

/* Loader (basado en css-loaders) ajustado a tu paleta */
.loader{
  width: 96px;
  height: 18px;

  -webkit-mask:
    conic-gradient(from 135deg at top   ,#0000,#000 .5deg 90deg,#0000 90.5deg) 0 0,
    conic-gradient(from -45deg at bottom,#0000,#000 .5deg 90deg,#0000 90.5deg) 0 100%;
  -webkit-mask-size: 25% 50%;
  -webkit-mask-repeat: repeat-x;

  mask:
    conic-gradient(from 135deg at top   ,#0000,#000 .5deg 90deg,#0000 90.5deg) 0 0,
    conic-gradient(from -45deg at bottom,#0000,#000 .5deg 90deg,#0000 90.5deg) 0 100%;
  mask-size: 25% 50%;
  mask-repeat: repeat-x;

  /* Verde #6aa189 + base suave para que se vea bien en oscuro */
  background: linear-gradient(var(--accent) 0 0) left/0% 100% no-repeat rgba(255,255,255,.18);
  animation: l13 1.8s infinite linear;
}

@keyframes l13{
  100% { background-size: 100% 100% }
}

    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 999;
    }

    .modal.open{ display: flex; }

    .modalCard{
      width: min(520px, 100%);
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      padding: 18px;
    }

    .modalCard label{ color: #0f172a; }

    .modalTitle{
      margin: 0 0 8px;
      font-size: 18px;
      font-weight: 800;
      color: #0f172a;
    }

    .modalSummary{
      font-size: 12px;
      color: #334155;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 12px;
      line-height: 1.35;
      word-break: break-word;
      white-space: pre-line;
    }

    .modalActions{
      display: flex;
      gap: 10px;
      margin-top: 12px;
      justify-content: flex-end;
    }

    .modalActions .btnGhost{
      background: #f1f5f9;
      color: #0f172a;
    }


    /* Responsive: sidebar arriba */
    @media (max-width: 900px){
      .app{ flex-direction:column; }
      .sidebar{
        width:100%;
        height:auto;
        position:relative;
        border-right:none;
        border-bottom:1px solid var(--border);
      }
      .content{ padding:16px; }
      .mainCard{ max-width:none; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebarTop">
        <div class="sidebarTitle">Pay-me Flex</div>
      </div>

      <div class="sidebarCard">
        <div class="grid">
          <div>
            <label>Client ID</label>
            <input id="clientId" placeholder="Client ID" />
          </div>

          <div>
            <label>Client Secret</label>
            <input id="clientSecret" type="password" placeholder="Client Secret" />
          </div>

          <div>
            <label>Merchant Code</label>
            <input id="merchantCode" placeholder="Merchant Code" />
          </div>

          <div>
            <label>Monto</label>
            <input id="amount" type="number" min="0" step="0.01" placeholder="Ej. 100.00" />
            <div class="hint">Se enviará en minor units (centavos) con 2 decimales.</div>
          </div>

          <div>
            <label>Moneda</label>
            <select id="currency">
              <option value="604">PEN (604)</option>
              <option value="840">USD (840)</option>
            </select>
          </div>

          <div>
            <label>Entorno</label>
            <select id="env">
              <option value="int">Integraciones</option>
              <option value="prod">Producción</option>
            </select>
            <div class="hint">Carga el JS/CSS de Flex según el entorno.</div>
          </div>
        </div>

        <div class="row">
          <button id="btnStart">Iniciar pago</button>
          <button id="btnTerminate" type="button" class="btnSecondary" disabled>Terminate</button>
          <span id="status" class="status" aria-live="polite">
            <span id="statusText"></span>
            <span id="statusLoader" class="loader" hidden></span>
          </span>

        </div>
      </div>

      <div class="sidebarFooter">
        <img src="PayMeBanner.png" alt="Banner Pay-me" style="width:100%; margin-top:20px;" />
      </div>
    </aside>


    <!-- MAIN CONTENT -->
    <main class="content">
      <div class="mainCard">
        <h3 style="margin:0 0 6px;">Checkout</h3>
        <div style="color:var(--muted); font-size:13px;">
          Aquí se renderiza el widget de Flex y la respuesta JSON.
        </div>

        <div id="flexMount"></div>
        <pre id="out">{}</pre>
      </div>
    </main>
  </div>

  <div id="credModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modalCard">
      <h4 class="modalTitle">Guardar credencial</h4>
      <div id="credSummary" class="modalSummary"></div>
      <form id="credForm">
        <label for="credOwner">A nombre de</label>
        <input id="credOwner" name="credOwner" placeholder="Ej. Maria Perez" required />
        <div class="modalActions">
          <button type="button" id="credCancel" class="btnGhost">Cancelar</button>
          <button type="submit">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (() => {
      "use strict";
      const $ = (id) => document.getElementById(id);

      const ENVS = {
        int: {
          tokenUrl: "https://auth.preprod.alignet.io/token",
          nonceUrl: "https://auth.preprod.alignet.io/nonce",
          audienceApi: "https://api.preprod.alignet.io",
          flexCssUrl: "https://flex.dev.pay-me.cloud/main-flex-payment-forms.css",
          flexJsUrl: "https://flex.dev.pay-me.cloud/flex-payment-forms.min.js",
        },
        prod: {
          tokenUrl: "https://auth.alignet.io/token",
          nonceUrl: "https://auth.alignet.io/nonce",
          audienceApi: "https://api.alignet.io",
          flexCssUrl: "https://flex.alignet.io/main-flex-payment-forms.css",
          flexJsUrl: "https://flex.alignet.io/flex-payment-forms.min.js",
        },
      };

      const DEFAULT_CREDS = {
        clientId: "Lj6tRqRzDiw56PPdSOOAgogT2HnIjf",
        clientSecret: "ijuVhdIETgcryjRRAJPGCd9nIu8HetTqDTIYe7VFcScgrprFY4Usu0e3H5KUPKeu",
        merchantCode: "453d8265-e01f-4ea5-9bfe-ca88b88e0beb",
      };

      const state = { pf: null, flexReady: Promise.resolve(), pendingCred: null };
      const CRED_LOG_KEY = "flexCredentialLog";

      function setStatus(msg) {
        const textEl = $("statusText");
        const loaderEl = $("statusLoader");

        const m = msg || "";
        textEl.textContent = m;

        // Si el mensaje contiene "cargando", muestra el loader
        const isLoading = /cargando/i.test(m);
        loaderEl.hidden = !isLoading;
      }

      function showJson(obj) { $("out").textContent = JSON.stringify(obj ?? {}, null, 2); }

      function generateMerchantOperationNumber() {
        const seconds = Math.floor(Date.now() / 1000).toString();
        const rnd = Math.floor(100000 + Math.random() * 900000).toString();
        return (seconds + rnd).slice(-12);
      }

      function amountToMinorUnits(amountStr, decimals = 2) {
        const normalized = String(amountStr || "").trim().replace(/\s/g, "").replace(",", ".");
        if (!/^\d+(\.\d{0,2})?$/.test(normalized)) throw new Error("Monto inválido");
        const [intPart, decPartRaw = ""] = normalized.split(".");
        const decPart = (decPartRaw + "0".repeat(decimals)).slice(0, decimals);
        const factor = BigInt(10) ** BigInt(decimals);
        const minor = BigInt(intPart) * factor + BigInt(decPart);
        return minor.toString();
      }

      function getCreds() {
        return {
          clientId: ($("clientId").value || "").trim() || DEFAULT_CREDS.clientId,
          clientSecret: ($("clientSecret").value || "").trim() || DEFAULT_CREDS.clientSecret,
          merchantCode: ($("merchantCode").value || "").trim() || DEFAULT_CREDS.merchantCode,
        };
      }

      function loadCredLog() {
        try {
          const raw = localStorage.getItem(CRED_LOG_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch {
          return [];
        }
      }

      function saveCredLog(records) {
        localStorage.setItem(CRED_LOG_KEY, JSON.stringify(records));
      }

      function buildCredTxt(records) {
        return records.map((r, idx) => {
          const lines = [
            `#${idx + 1}`,
            `timestamp: ${r.timestamp}`,
            `owner: ${r.owner}`,
            `clientId: ${r.clientId}`,
            `clientSecret: ${r.clientSecret}`,
            `merchantCode: ${r.merchantCode}`,
            `env: ${r.env}`,
            `amountMinor: ${r.amountMinor}`,
            `currency: ${r.currency}`,
            `merchantOperationNumber: ${r.merchantOperationNumber}`,
          ];
          return lines.join("\n");
        }).join("\n\n");
      }

      function downloadTxt(content, filename) {
        const blob = new Blob([content], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function openCredModal(creds, meta) {
        const summary = [
          `clientId: ${creds.clientId}`,
          `merchantCode: ${creds.merchantCode}`,
          `env: ${meta.env}`,
          `amountMinor: ${meta.amountMinor} ${meta.currency}`,
        ].join("\n");
        $("credSummary").textContent = summary;
        $("credOwner").value = "";
        $("credModal").classList.add("open");
        $("credModal").setAttribute("aria-hidden", "false");
        $("credOwner").focus();
        state.pendingCred = { creds, meta };
      }

      function closeCredModal() {
        $("credModal").classList.remove("open");
        $("credModal").setAttribute("aria-hidden", "true");
        state.pendingCred = null;
      }

      async function fetchJson(url, body, token) {
        const headers = { "Content-Type": "application/json" };
        if (token) headers.Authorization = `Bearer ${token}`;
        const r = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) {
          const msg = j?.error_description || j?.message || `HTTP ${r.status}`;
          throw new Error(msg);
        }
        return j;
      }

      async function obtenerAccessToken(cfg) {
        const { clientId, clientSecret } = getCreds();
        const j = await fetchJson(cfg.tokenUrl, {
          action: "authorize",
          grant_type: "client_credentials",
          audience: cfg.audienceApi,
          client_id: clientId,
          client_secret: clientSecret,
          scope: "create:token post:charges offline_access",
        });
        return j.access_token;
      }

      async function obtenerNonce(cfg, token) {
        const { clientId } = getCreds();
        const j = await fetchJson(cfg.nonceUrl, {
          action: "create.nonce",
          audience: cfg.audienceApi,
          client_id: clientId,
          scope: "post:charges",
        }, token);
        return j.nonce;
      }

      function loadFlexAssets(cfg) {
        let link = document.getElementById("flex-css");
        if (!link) {
          link = document.createElement("link");
          link.id = "flex-css";
          link.rel = "stylesheet";
          document.head.appendChild(link);
        }
        link.href = cfg.flexCssUrl;

        const current = document.getElementById("flex-js");
        if (current && current.getAttribute("data-src") === cfg.flexJsUrl && window.FlexPaymentForms) {
          return Promise.resolve();
        }
        if (current) current.remove();

        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.id = "flex-js";
          s.src = cfg.flexJsUrl;
          s.async = true;
          s.setAttribute("data-src", cfg.flexJsUrl);
          s.onload = () => resolve();
          s.onerror = () => reject(new Error("No se pudo cargar FlexPaymentForms"));
          document.head.appendChild(s);
        });
      }

      function cleanup() {
        try { state.pf?.terminate?.(); } catch {}
        state.pf = null;
        $("flexMount").innerHTML = "";
        $("btnTerminate").disabled = true;
      }

      async function start() {
        cleanup();
        showJson({});
        setStatus("Cargando...");

        $("btnStart").disabled = true;

        try {
          const envKey = $("env").value || "int";
          const cfg = ENVS[envKey] || ENVS.int;

          state.flexReady = loadFlexAssets(cfg);
          await state.flexReady;

          const amountInput = $("amount").value;
          const currency = $("currency").value || "604";
          const amountMinor = amountToMinorUnits(amountInput, 2);
          if (amountMinor === "0") throw new Error("Ingresa un monto válido.");

          const token = await obtenerAccessToken(cfg);
          const nonce = await obtenerNonce(cfg, token);

          const { merchantCode } = getCreds();
          const merchantOperationNumber = generateMerchantOperationNumber();
          const redirectBack = window.location.origin + window.location.pathname;

          const payload = {
            action: "authorize",
            channel: "ecommerce",
            merchant_code: merchantCode,
            merchant_operation_number: merchantOperationNumber,
            payment_method: { method_details: { redirect_url: redirectBack } },
            payment_details: {
              amount: amountMinor,
              currency,
              billing: {
                first_name: "Test",
                last_name: "User",
                email: "test.user@pay-me.com",
                phone: { country_code: "+51", subscriber: "999999999" },
                location: { line_1: "Av. Ejemplo 123", city: "Lima", state: "Lima", country: "Peru" },
              },
            },
          };

          if (typeof window.FlexPaymentForms !== "function") {
            throw new Error("FlexPaymentForms no está disponible.");
          }

          const pf = new window.FlexPaymentForms({
            nonce,
            payload,
            settings: {
              show_close_button: true,
              display_result_screen: true,
            },
            display_settings: { methods: ["CARD","YAPE","PAGOEFECTIVO"] },
          });

          state.pf = pf;
          $("btnTerminate").disabled = false;

          setStatus("Listo (Flex iniciado)");
          pf.init(
            $("flexMount"),
            (resp) => { setStatus("SUCCESS"); showJson(resp); cleanup(); },
            (track) => { /* opcional */ },
            (err)  => { setStatus("ERROR");  showJson(err);  cleanup(); }
          );

          openCredModal(getCreds(), {
            env: envKey,
            amountMinor,
            currency,
            merchantOperationNumber,
          });
        } catch (e) {
          setStatus("Fallo");
          showJson({ message: e?.message || "Error" });
          cleanup();
        } finally {
          $("btnStart").disabled = false;
        }
      }

      $("btnStart").addEventListener("click", start);
      $("btnTerminate").addEventListener("click", () => { cleanup(); setStatus("Terminated"); });

      $("credCancel").addEventListener("click", closeCredModal);
      $("credForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const owner = ($("credOwner").value || "").trim();
        if (!owner || !state.pendingCred) return;
        const { creds, meta } = state.pendingCred;
        const records = loadCredLog();
        records.push({
          timestamp: new Date().toISOString(),
          owner,
          clientId: creds.clientId,
          clientSecret: creds.clientSecret,
          merchantCode: creds.merchantCode,
          env: meta.env,
          amountMinor: meta.amountMinor,
          currency: meta.currency,
          merchantOperationNumber: meta.merchantOperationNumber,
        });
        saveCredLog(records);
        downloadTxt(buildCredTxt(records), "credenciales-flex.txt");
        closeCredModal();
      });

      $("clientId").value = DEFAULT_CREDS.clientId;
      $("clientSecret").value = DEFAULT_CREDS.clientSecret;
      $("merchantCode").value = DEFAULT_CREDS.merchantCode;
      $("amount").value = "1.00";
    })();
  </script>
</body>
</html>
