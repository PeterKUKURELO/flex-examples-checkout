<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pago | EJEMPLO SDK</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --payme-teal:#6aa189;
      --payme-teal-dark:#45675e;

      --azul: var(--payme-teal);
      --azul-osc: var(--payme-teal-dark);
      --azul-claro:#e4f2ee;

      --blanco:#ffffff;
      --gris-900:#1c1c1c;
      --gris-600:#5b5b5b;
      --gris-200:#eaeaea;
      --fondo:#f9f9f9;

      --radius-lg:16px;
      --radius-xl:22px;
      --shadow-1:0 6px 18px rgba(0,0,0,.06);
      --shadow-2:0 14px 34px rgba(0,0,0,.12);
      --timing:.25s cubic-bezier(.2,.7,.2,1);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: Inter, Arial, sans-serif;
      background: var(--fondo);
      color:var(--gris-900);
      -webkit-font-smoothing:antialiased;
    }

    header{
      background:var(--blanco);
      height:72px;
      display:flex;
      align-items:center;
      padding:0 20px;
      box-shadow:0 1px 0 var(--gris-200);
      gap:12px;
    }
    .header-logo{height:46px; width:auto; cursor:pointer}

    .header-actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .field { display:flex; flex-direction:column; gap:4px; }
    .select-wrap{ position: relative; }

    header .select-wrap select{
      min-width: 190px;
      padding: 10px 40px 10px 12px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 13px;
      border:1px solid var(--gris-200);
      background:#fff;
      appearance:none;
    }
    .select-wrap i{
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      color: var(--gris-600);
      pointer-events: none;
    }

    .quick-link{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      text-decoration: none;
      color: inherit;
    }
    .quick-link:hover{ background: rgba(0,0,0,.06); }

    .env-btn{
      border:none;
      padding:8px 12px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      transition: background var(--timing), transform var(--timing), color var(--timing);
      white-space: nowrap;
      border:1px solid var(--gris-200);
      background: rgba(255,255,255,.65);
      color:var(--azul-osc);
      backdrop-filter: blur(6px);
    }
    .env-btn:hover{transform:translateY(-1px)}
    .env-btn.active{
      background:var(--azul);
      color:#fff;
      box-shadow:var(--shadow-1);
      border-color: transparent;
    }

    .dark-toggle{
      background: transparent;
      border: none;
      font-size: 1.4rem;
      color: var(--gris-200);
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 10px;
      transition: background .25s, transform .25s;
    }
    .dark-toggle:hover { background: var(--gris-200); transform: scale(1.1); }
    body.dark .dark-toggle { color: var(--gris-900); }
    body.dark .dark-toggle:hover { background: #2a2a2a; }

    .stage{
      display:grid;
      grid-template-columns: 430px 1fr;
      min-height:calc(100vh - 72px);
      position:relative;
    }
    .stage::before{
      content:"";
      position:absolute;
      inset:0 38% 0 0;
      background: linear-gradient(160deg, var(--azul), var(--azul-osc));
      clip-path: polygon(0 0, 100% 0, 86% 100%, 0% 100%);
      z-index:0;
    }

    .options{
      grid-column:1/2;
      align-self:center;
      margin:40px;
      background:var(--blanco);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow-2);
      padding:28px;
      width:min(380px, 90%);
      z-index:2;
      position:relative;
    }
    .options h2{
      font-size:22px;
      font-weight:700;
      color:var(--azul-osc);
      margin-bottom:6px;
    }
    .sub{font-size:13px; color:var(--gris-600); margin-bottom:18px}

    .field label { font-size:14px; font-weight:600; color:var(--azul-osc); }

    .field input{
      padding:12px 14px;
      border-radius:10px;
      border:1px solid var(--gris-200);
      background:#fff;
      font-size:15px;
      transition:border var(--timing), box-shadow var(--timing);
    }
    .field input:focus{
      border-color:var(--azul);
      box-shadow:0 0 0 3px var(--azul-claro);
      outline:none;
    }

    .field select{
      width: 100%;
      padding: 12px 44px 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--gris-200);
      background: #fff;
      font-size: 15px;
      font-family: Inter, Arial, sans-serif;
      transition: border var(--timing), box-shadow var(--timing);
      appearance: none;
    }
    .field select:focus{
      border-color: var(--azul);
      box-shadow: 0 0 0 3px var(--azul-claro);
      outline: none;
    }

    .stack{display:flex; flex-direction:column; gap:14px}

    .metodos-title{
      font-size:18px;
      font-weight:700;
      color:var(--azul-osc);
      display:flex;
      align-items:center;
      gap:10px;
    }

    .metodos-grid{
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .metodo-item input{ display:none; }
    .metodo-box{
      display:flex;
      align-items:center;
      gap:10px;
      padding:14px 16px;
      background:#fff;
      border:2px solid #e6eef0;
      border-radius:12px;
      transition:.25s;
    }
    .metodo-item input:checked + .metodo-box{
      border-color: var(--azul);
      box-shadow: 0 4px 12px rgba(0,0,0,.05);
    }
    .check{
      width: 20px;
      height: 20px;
      border: 2px solid var(--azul);
      border-radius: 6px;
      position: relative;
    }
    .metodo-item input:checked + .metodo-box .check{
      background: var(--azul);
      border-color: var(--azul);
    }
    .metodo-item input:checked + .metodo-box .check::after{
      content: "âœ”";
      position: absolute;
      color: #fff;
      font-size: 13px;
      left: 2px;
      top: -1px;
    }
    .metodo-text{ font-size: 15px; font-weight: 600; color: var(--gris-900); }
    .logo-icon,.logos img{ height:26px; }
    .logos img.card{ height:18px; margin-right:5px; }

    .payment-option{
      --w:100%;
      width:var(--w);
      align-self:flex-start;
      padding:14px 18px;
      font-weight:600;
      font-size:15px;
      background:var(--azul);
      color:#fff;
      border:none;
      border-radius:12px;
      box-shadow:var(--shadow-1);
      cursor:pointer;
      transition: transform var(--timing), background var(--timing), box-shadow var(--timing);
    }
    .payment-option:hover{ background:var(--azul-osc); transform:translateY(-1px); box-shadow:0 8px 22px rgba(0,102,179,.25)}
    .payment-option:active{ transform:translateY(0)}
    .payment-option:focus-visible{ outline:3px solid var(--azul-claro); outline-offset:2px}
    .payment-option:nth-child(1){ --w: 85% }
    .payment-option:nth-child(2){ --w: 65% }
    .payment-option:nth-child(3){ --w: 95% }

    .payment-wrap{
      grid-column:2/3;
      display:flex; align-items:center; justify-content:center;
      padding:50px;
      z-index:1;
    }
    .payment-container{
      position: relative;
      width:min(950px, 100%);
      background:var(--blanco);
      border:1px solid var(--gris-200);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-1);
      padding:28px;
    }

    #loading{font-size:18px; color:#666; display:none}
    #demo{display:none; width:100%}

    .modal{
      display:none; position:fixed; inset:0; z-index:1000;
      background:rgba(0,0,0,.55);
      backdrop-filter:blur(3px);
    }
    .modal-content{
      background:#fff; margin:6% auto; padding:26px;
      width:min(640px, 92%); border-radius:20px; position:relative;
      box-shadow:0 24px 60px rgba(0,0,0,.24);
    }
    .close{
      position:absolute; right:16px; top:12px; font-size:28px; color:#999; cursor:pointer; padding:2px 8px;
    }
    .close:hover{color:#000; background:#f3f3f3; border-radius:6px}

    .stage.expandido::before{display:none}
    .stage.expandido .options{display:none}
    .stage.expandido .payment-wrap{grid-column:1/-1}
    .stage.expandido .payment-container{width:min(1080px, 96%)}

    /* Overlay video (no oculta UI) */
    .payme-overlay{
      position:absolute;
      inset:0;
      z-index:9999;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(2px);
      border-radius: inherit;
      pointer-events:none;
    }
    .payme-overlay video{
      max-width: 420px;
      width: min(420px, 80%);
      border-radius: 16px;
    }

    /* Resultado bonito */
    .result-card{
      border: 1px solid var(--gris-200);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
      background: var(--blanco);
    }
    .result-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .result-title{
      font-size: 18px;
      font-weight: 800;
      color: var(--azul-osc);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      font-weight: 800;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--gris-200);
    }
    .badge.ok{
      background: rgba(106,161,137,.12);
      color: var(--azul-osc);
      border-color: rgba(106,161,137,.35);
    }
    .badge.fail{
      background: rgba(180,35,24,.10);
      color: #b42318;
      border-color: rgba(180,35,24,.35);
    }
    .result-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .result-item{
      padding: 12px;
      border: 1px solid var(--gris-200);
      border-radius: 14px;
      background: rgba(0,0,0,.02);
    }
    .result-label{
      font-size: 12px;
      font-weight: 800;
      color: var(--gris-600);
      margin-bottom: 6px;
    }
    .result-value{
      font-size: 15px;
      font-weight: 800;
      color: var(--gris-900);
      word-break: break-word;
    }
    .result-actions{
      display:flex;
      gap:10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    .btn-soft{
      border: 1px solid var(--gris-200);
      background: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      cursor: pointer;
    }
    .btn-primary{
      border: none;
      background: var(--azul);
      color:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      cursor: pointer;
    }
    .btn-primary:hover{ background: var(--azul-osc); }

    /* Session controls */
    .session-controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
      padding:12px 14px;
      border:1px solid var(--gris-200);
      border-radius:12px;
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(6px);
    }
    .session-left{flex:1; min-width: 220px;}
    .session-title{
      font-weight:700;
      color:var(--azul-osc);
      margin-bottom:8px;
      display:flex;
      gap:8px;
      align-items:baseline;
    }
    .session-bar{
      height:10px;
      background: var(--gris-200);
      border-radius:999px;
      overflow:hidden;
    }
    .session-bar-fill{
      height:100%;
      width:100%;
      background: var(--azul);
      transition: width .25s linear;
    }
    .session-right{ display:flex; align-items:center; gap:10px; }
    .session-right label{
      font-size:12px;
      font-weight:700;
      color:var(--gris-600);
    }
    .session-right input{
      width:74px;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--gris-200);
      background:#fff;
      font-weight:700;
    }
    .session-apply{
      border:none;
      padding:10px 12px;
      border-radius:10px;
      background: var(--azul);
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    .session-apply:hover{ background: var(--azul-osc); }

    /* Dark */
    body.dark{
      --fondo: #121212;
      --blanco: #1e1e1e;
      --gris-900: #f5f5f5;
      --gris-600: #cccccc;
      --gris-200: #2c2c2c;

      --azul: #6aa189;
      --azul-osc: #395047;
      --azul-claro: #223a34;
    }
    body.dark header{ background: var(--gris-200); box-shadow: 0 1px 0 #333; }
    body.dark .env-btn{ background: rgba(30,30,30,.55); border-color:#333; color: var(--gris-900); }
    body.dark .env-btn.active{ color:#fff; }
    body.dark input, body.dark select{ background:#111; border-color:#333; color: var(--gris-900); }
    body.dark input::placeholder{ color:#777; }

    @media(max-width:980px){
      .stage{grid-template-columns:1fr}
      .stage::before{inset:0; clip-path: polygon(0 0, 100% 0, 100% 42%, 0% 70%)}
      .options{margin:28px auto 10px; width:min(500px, 92%)}
      .payment-wrap{padding:24px 16px}
    }
    @media(max-width:700px){
      .result-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <header>
    <img
      src="https://pay-me.com/wp-content/uploads/2021/08/cropped-cropped-logo-payme.png"
      alt="Pay-me"
      class="header-logo"
      onclick="volverAlInicio()"
    />

    <div class="header-actions">
      <div class="field" style="margin:0">
        <div class="select-wrap">
          <select id="envSelect" onchange="onEnvChange(event)">
            <option value="dev">Dev</option>
            <option value="prod">Prod</option>
          </select>
          <i class="bi bi-chevron-down"></i>
        </div>
      </div>

      <a
        class="quick-link"
        href="https://docs.pay-me.com/es/acceso-r-pidos/Working-version/datos-de-prueba"
        target="_blank"
        rel="noopener noreferrer"
        title="Datos de prueba"
        aria-label="Abrir datos de prueba"
      >
        <i class="bi bi-credit-card"></i>
      </a>

      <button type="button" class="env-btn" id="toggleAnimBtn" onclick="toggleAnimMode(event)">
        AnimaciÃ³n final: OFF
      </button>

      <button type="button" class="dark-toggle" onclick="toggleDarkMode(event)" aria-label="Cambiar tema">
        <i class="bi bi-moon"></i>
      </button>
    </div>
  </header>

  <main class="stage">
    <section class="options" aria-labelledby="ops-title">
      <h2 id="ops-title">Credenciales Pay-me</h2>
      <p class="sub">Ingresa las credenciales necesarias</p>

      <div class="stack">
        <div class="field">
          <label for="clientId">Client ID</label>
          <input id="clientId" type="text" placeholder="Client ID">
        </div>

        <div class="field">
          <label for="clientSecret">Client Secret</label>
          <input id="clientSecret" type="password" placeholder="Client Secret">
        </div>

        <div class="field">
          <label for="merchantCode">Merchant Code</label>
          <input id="merchantCode" type="text" placeholder="Merchant Code">
        </div>
      </div>

      <h3 class="metodos-title" style="margin-top:22px">Monto de Pago</h3>

      <div class="stack">
        <div class="field">
          <label for="amount">Monto</label>
          <input id="amount" type="number" min="0" step="0.01" placeholder="Ej. 100.00">
          <small>Ingresa el monto en la moneda seleccionada.</small>
        </div>

        <div class="field">
          <label for="currency">Moneda</label>
          <div class="select-wrap">
            <select id="currency">
              <option value="604">PEN - Soles (604)</option>
              <option value="840">USD - DÃ³lares (840)</option>
            </select>
            <i class="bi bi-chevron-down"></i>
          </div>
        </div>
      </div>

      <h3 class="metodos-title" style="margin-top:22px">MÃ©todos de Pago</h3>

      <div class="metodos-grid">
        <label class="metodo-item">
          <input type="checkbox" checked id="mp-tarjetas">
          <div class="metodo-box">
            <span class="check"></span>
            <span class="metodo-text">Tarjetas</span>
            <div class="logos">
              <img src="visa.png" class="card" alt="">
              <img src="mstc.png" class="card" alt="">
              <img src="amex.png" class="card" alt="">
              <img src="dinners.png" class="card" alt="">
            </div>
          </div>
        </label>

        <label class="metodo-item">
          <input type="checkbox" id="mp-yape">
          <div class="metodo-box">
            <span class="check"></span>
            <span class="metodo-text">Yape</span>
            <img src="yape.png" class="logo-icon" alt="">
          </div>
        </label>

        <label class="metodo-item">
          <input type="checkbox" id="mp-qr">
          <div class="metodo-box">
            <span class="check"></span>
            <span class="metodo-text">QR</span>
            <img src="qr.png" class="logo-icon" alt="">
          </div>
        </label>

        <label class="metodo-item">
          <input type="checkbox" id="mp-cuotealo">
          <div class="metodo-box">
            <span class="check"></span>
            <span class="metodo-text">CuotÃ©alo</span>
            <img src="cuotealo.png" class="logo-icon" alt="">
          </div>
        </label>

        <label class="metodo-item">
          <input type="checkbox" id="mp-pagoefectivo">
          <div class="metodo-box">
            <span class="check"></span>
            <span class="metodo-text">Pago Efectivo</span>
            <img src="pagoefectivo.png" class="logo-icon" alt="">
          </div>
        </label>
      </div>

      <div class="stack" style="margin-top:22px">
        <button class="payment-option" onclick="abrirFormularioNormal(200000)">Formulario Normal</button>
        <button class="payment-option" onclick="abrirModal(100)">Pop Up</button>
        <button class="payment-option" onclick="abrirFormularioExpandido(1500)">Formulario Expandido</button>
      </div>
    </section>

    <div class="payment-wrap">
      <div class="payment-container">
        <div id="sessionControls" class="session-controls" style="display:none;">
          <div class="session-left">
            <div class="session-title">Vence en <span id="sessionCountdown">05:00</span></div>
            <div class="session-bar"><div id="sessionBarFill" class="session-bar-fill"></div></div>
          </div>
          <div class="session-right">
            <label for="sessionMinutes">Min</label>
            <input id="sessionMinutes" type="number" min="1" max="60" value="5" />
            <button type="button" class="session-apply" onclick="restartSessionTimer()">Aplicar</button>
          </div>
        </div>

        <div id="loading">Cargando pasarela...</div>
        <div id="demo"></div>

        <div id="resultadoPago" style="margin-top:20px; padding:16px; background:#fff; border-radius:12px; display:none;"></div>

        <div id="paymeOverlay" class="payme-overlay" style="display:none;"></div>
      </div>
    </div>
  </main>

  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarModal()">&times;</span>
      <h3 style="margin:4px 0 12px;color:#222">Pagar</h3>
      <div id="loadingModal">Cargando pasarela...</div>
      <div id="demoModal"></div>
    </div>
  </div>

  <script>
    (() => {
      "use strict";

      const $ = (id) => document.getElementById(id);

      const LS = {
        getJson(key, fallback = null) {
          try {
            const raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : fallback;
          } catch { return fallback; }
        },
        setJson(key, value) {
          try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
        },
        getStr(key, fallback = "") {
          try { return localStorage.getItem(key) ?? fallback; } catch { return fallback; }
        },
        setStr(key, value) {
          try { localStorage.setItem(key, String(value)); } catch {}
        },
      };

      const escapeHtml = (v) =>
        String(v ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");

      const getQueryParam = (name) => new URLSearchParams(window.location.search).get(name);

      const DEFAULT_CREDS = {
        clientId: "Lj6tRqRzDiw56PPdSOOAgogT2HnIjf",
        clientSecret: "ijuVhdIETgcryjRRAJPGCd9nIu8HetTqDTIYe7VFcScgrprFY4Usu0e3H5KUPKeu",
        merchantCode: "453d8265-e01f-4ea5-9bfe-ca88b88e0beb",
      };

      const ENVS = {
        dev: {
          tokenUrl: "https://auth.preprod.alignet.io/token",
          nonceUrl: "https://auth.preprod.alignet.io/nonce",
          audienceApi: "https://api.preprod.alignet.io",
          flexCssUrl: "https://flex.dev.pay-me.cloud/main-flex-payment-forms.css",
          flexJsUrl: "https://flex.dev.pay-me.cloud/flex-payment-forms.min.js",
        },
        prod: {
          tokenUrl: "https://auth.alignet.io/token",
          nonceUrl: "https://auth.alignet.io/nonce",
          audienceApi: "https://api.alignet.io",
          flexCssUrl: "https://flex.alignet.io/main-flex-payment-forms.css",
          flexJsUrl: "https://flex.alignet.io/flex-payment-forms.min.js",
        },
      };

      const LABELS = {
        method: {
          CARD: "Tarjeta",
          YAPE: "Yape",
          QR: "QR",
          PAGOEFECTIVO: "PagoEfectivo",
          CUOTEALO: "CuotÃ©alo",
        },
        brand: {
          VISA: "VISA",
          AMEX: "AMEX",
          "AMERICAN EXPRESS": "AMEX",
          DINERS: "Diners",
          "DINERS CLUB": "Diners",
          MSCD: "MasterCard",
          MASTERCARD: "MasterCard",
          MASTER: "MasterCard",
        },
        currencySymbol: { "604": "S/.", "840": "$" },
      };

      function currencySymbol(code) {
        const c = String(code || "").trim();
        return LABELS.currencySymbol[c] ?? (c || "â€”");
      }

      function formatMinorAmount(amountMinor, currencyCode) {
        const raw = String(amountMinor ?? "").trim();
        if (!raw || !/^\d+$/.test(raw)) return "â€”";
        const padded = raw.padStart(3, "0");
        const intPart = padded.slice(0, -2);
        const decPart = padded.slice(-2);
        return `${currencySymbol(currencyCode)} ${Number(intPart)}.${decPart}`;
      }

      function amountToMinorUnits(amountStr, decimals = 2) {
        const normalized = String(amountStr || "")
          .trim()
          .replace(/\s/g, "")
          .replace(",", ".");

        if (!/^\d+(\.\d{0,2})?$/.test(normalized)) throw new Error("Monto invÃ¡lido");

        const [intPart, decPartRaw = ""] = normalized.split(".");
        const decPart = (decPartRaw + "0".repeat(decimals)).slice(0, decimals);

        const factor = BigInt(10) ** BigInt(decimals);
        const minor = BigInt(intPart) * factor + BigInt(decPart);
        return minor.toString();
      }

      function setAmountIfProvided(minorUnitsMaybe) {
        if (minorUnitsMaybe === undefined || minorUnitsMaybe === null) return;
        const el = $("amount");
        if (!el) return;
        const current = (el.value || "").trim();
        if (current) return;

        const n = Number(minorUnitsMaybe);
        if (!Number.isFinite(n) || n <= 0) return;
        el.value = (n / 100).toFixed(2);
      }

      function normalizeMethodName(method) {
        const m = String(method || "").trim().toUpperCase();
        return LABELS.method[m] ?? (m || "â€”");
      }

      function normalizeBrand(brand) {
        const b = String(brand || "").trim().toUpperCase();
        return LABELS.brand[b] ?? (b || "â€”");
      }

      function extractGatewayTransactionId(obj) {
        const v =
          obj?.transaction?.transaction_id ||
          obj?.transaction_id ||
          obj?.data?.transaction?.transaction_id ||
          obj?.result?.transaction?.transaction_id;
        return v ? String(v).trim() : null;
      }

      function generateMerchantOperationNumber() {
        const seconds = Math.floor(Date.now() / 1000).toString();
        const rnd = Math.floor(100000 + Math.random() * 900000).toString();
        return (seconds + rnd).slice(-12);
      }

      const state = {
        envKey: "dev",
        cfg: ENVS.dev,
        flexReady: Promise.resolve(),
        pf: null,
        pfTarget: null,
        cancelCtx: { merchantCode: null, merchantOperationNumber: null, gatewayChargeId: null },
        sessionInterval: null,
        sessionDeadline: 0,
        sessionTotalMs: 0,
      };

      const els = {};
      function cacheEls() {
        Object.assign(els, {
          envSelect: $("envSelect"),
          loading: $("loading"),
          demo: $("demo"),
          loadingModal: $("loadingModal"),
          demoModal: $("demoModal"),
          result: $("resultadoPago"),
          overlay: $("paymeOverlay"),
          toggleAnimBtn: $("toggleAnimBtn"),
          modal: $("paymentModal"),
          stage: document.querySelector(".stage"),
          sessionControls: $("sessionControls"),
          sessionCountdown: $("sessionCountdown"),
          sessionBarFill: $("sessionBarFill"),
          sessionMinutes: $("sessionMinutes"),
          amount: $("amount"),
          currency: $("currency"),
          clientId: $("clientId"),
          clientSecret: $("clientSecret"),
          merchantCode: $("merchantCode"),
          darkIcon: document.querySelector(".dark-toggle i"),
        });
      }

      /* =========================
        Toggle: AnimaciÃ³n final
        - ON  => display_result_screen: false (tu pantalla bonita)
        - OFF => display_result_screen: true  (pantalla final gateway)
      ========================= */
      function isAnimModeEnabled() {
        return LS.getStr("payme_anim_mode", "false") === "true";
      }

      function getDisplayResultScreenSetting() {
        // Si anim ON => false (no mostrar result screen del gateway)
        // Si anim OFF => true (mostrar result screen del gateway)
        return !isAnimModeEnabled();
      }

      function setAnimModeEnabled(enabled) {
        LS.setStr("payme_anim_mode", String(!!enabled));
        updateAnimModeButton();
      }

      function updateAnimModeButton() {
        const enabled = isAnimModeEnabled();
        const btn = els.toggleAnimBtn || $("toggleAnimBtn");
        if (!btn) return;
        btn.textContent = `AnimaciÃ³n final: ${enabled ? "ON" : "OFF"}`;
        btn.classList.toggle("active", enabled);
      }

      function toggleAnimMode(ev) {
        ev?.stopPropagation?.();
        const next = !isAnimModeEnabled();
        setAnimModeEnabled(next);
      }

      /* Theme */
      function applySavedTheme() {
        const dark = LS.getStr("payme_dark_mode", "false") === "true";
        if (dark) document.body.classList.add("dark");
        if (els.darkIcon) els.darkIcon.className = dark ? "bi bi-sun" : "bi bi-moon";
      }

      function toggleDarkMode(ev) {
        ev?.stopPropagation?.();
        document.body.classList.toggle("dark");
        const dark = document.body.classList.contains("dark");
        if (els.darkIcon) els.darkIcon.className = dark ? "bi bi-sun" : "bi bi-moon";
        LS.setStr("payme_dark_mode", String(dark));
      }

      /* Env + Flex assets */
      function getEnvKey() {
        const stored = LS.getStr("payme_env", "dev");
        return stored === "int" ? "dev" : stored;
      }

      function setEnv(envKey) {
        state.envKey = envKey;
        state.cfg = ENVS[envKey] || ENVS.dev;
        LS.setStr("payme_env", envKey);
      }

      function loadFlexAssets(envKey) {
        const cfg = ENVS[envKey] || ENVS.dev;

        let link = document.getElementById("flex-css");
        if (!link) {
          link = document.createElement("link");
          link.id = "flex-css";
          link.rel = "stylesheet";
          document.head.appendChild(link);
        }
        link.href = cfg.flexCssUrl;

        const current = document.getElementById("flex-js");
        if (current && current.getAttribute("data-src") === cfg.flexJsUrl && window.FlexPaymentForms) {
          return Promise.resolve();
        }
        if (current) current.remove();

        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.id = "flex-js";
          s.src = cfg.flexJsUrl;
          s.async = true;
          s.setAttribute("data-src", cfg.flexJsUrl);
          s.onload = () => resolve();
          s.onerror = () => reject(new Error("No se pudo cargar FlexPaymentForms"));
          document.head.appendChild(s);
        });
      }

      async function initEnvSelect() {
        const envKey = getEnvKey();
        setEnv(envKey);
        if (els.envSelect) els.envSelect.value = envKey;
        state.flexReady = loadFlexAssets(envKey);
        await state.flexReady;
      }

      async function onEnvChange(ev) {
        ev?.stopPropagation?.();
        const envKey = ev?.target?.value || "dev";
        setEnv(envKey);
        state.flexReady = loadFlexAssets(envKey);
        await state.flexReady;
      }

      /* Overlay */
      function clonePaymeLoadingVideo() {
        const videoWrap = document.querySelector(".payment-gateway-ui .loading-detail.loading-video");
        return videoWrap ? videoWrap.cloneNode(true) : null;
      }

      function showPaymeOverlayWithNode(node) {
        if (!els.overlay) return;
        els.overlay.innerHTML = "";
        if (node) els.overlay.appendChild(node);
        els.overlay.style.display = "flex";
        const vid = els.overlay.querySelector("video");
        if (vid) {
          vid.muted = true;
          vid.playsInline = true;
          vid.autoplay = true;
          vid.loop = true;
          vid.play?.().catch(() => {});
        }
      }

      function hidePaymeOverlay() {
        if (!els.overlay) return;
        els.overlay.style.display = "none";
        els.overlay.innerHTML = "";
      }

      function showFinalAnimationOverlayIfEnabled() {
        if (!isAnimModeEnabled()) return;
        const anim = clonePaymeLoadingVideo();
        if (!anim) return;
        showPaymeOverlayWithNode(anim);
      }

      /* Results */
      function clearGatewayResults() {
        if (!els.result) return;
        els.result.innerHTML = "";
        els.result.style.display = "none";
      }

      function saveLastGatewayResult(type, data) {
        LS.setJson("payme_last_result", { type, at: new Date().toISOString(), ctx: state.cancelCtx, data });
      }

      function extractPaymentViewModel(resp, ctx) {
        const tx = resp?.transaction || {};
        const pm = tx?.payment_method || {};
        const md = pm?.method_details || {};

        const methodRaw = String(pm?.method_name || "").trim().toUpperCase();
        const methodLabel = normalizeMethodName(methodRaw);

        const merchantOperationNumber =
          resp?.merchant_operation_number ||
          tx?.merchant_operation_number ||
          ctx?.merchantOperationNumber ||
          "â€”";

        const amountMinor = tx?.amount ?? "â€”";
        const currency = tx?.currency ?? "â€”";
        const amountFormatted = formatMinorAmount(amountMinor, currency);

        const gatewayChargeId =
          extractGatewayTransactionId(resp) ||
          tx?.transaction_id ||
          ctx?.gatewayChargeId ||
          "â€”";

        const brand = normalizeBrand(md?.brand);
        const maskedPan = md?.masked_pan ? String(md.masked_pan) : "â€”";

        const phone =
          md?.phone?.subscriber
            ? `${md?.phone?.country_code || ""}${md.phone.subscriber}`
            : "â€”";

        return {
          state: tx?.state || "â€”",
          stateReason: tx?.state_reason || "â€”",
          merchantOperationNumber: String(merchantOperationNumber),
          amountFormatted,
          gatewayChargeId: String(gatewayChargeId),
          methodLabel,
          brand,
          maskedPan,
          phone,
          showCardFields: methodRaw === "CARD",
          showYapeFields: methodRaw === "YAPE",
        };
      }

      function renderPrettyResult(vm, rawResponse, isError = false) {
        if (!els.result) return;

        const ok = !isError && String(vm.state || "").toUpperCase() === "AUTORIZADO";
        const badgeClass = ok ? "ok" : "fail";
        const badgeText = ok ? "APROBADO" : "NO APROBADO";

        els.result.style.display = "block";
        els.result.innerHTML = `
          <div class="result-card">
            <div class="result-head">
              <div class="result-title">
                <i class="bi ${ok ? "bi-check-circle-fill" : "bi-x-circle-fill"}"></i>
                Resultado del Pago
              </div>
              <span class="badge ${badgeClass}">${badgeText}</span>
            </div>

            <div style="color:var(--gris-600); font-weight:700; margin-bottom:12px;">
              ${escapeHtml(vm.state)} â€” ${escapeHtml(vm.stateReason)}
            </div>

            <div class="result-grid">
              <div class="result-item">
                <div class="result-label">NÂ° OperaciÃ³n</div>
                <div class="result-value">${escapeHtml(vm.merchantOperationNumber)}</div>
              </div>

              <div class="result-item">
                <div class="result-label">Monto</div>
                <div class="result-value">${escapeHtml(vm.amountFormatted)}</div>
              </div>

              <div class="result-item">
                <div class="result-label">MÃ©todo</div>
                <div class="result-value">${escapeHtml(vm.methodLabel)}</div>
              </div>

              ${vm.showCardFields ? `
                <div class="result-item">
                  <div class="result-label">Marca</div>
                  <div class="result-value">${escapeHtml(vm.brand)}</div>
                </div>

                <div class="result-item">
                  <div class="result-label">Tarjeta</div>
                  <div class="result-value">${escapeHtml(vm.maskedPan)}</div>
                </div>
              ` : ""}

              ${vm.showYapeFields ? `
                <div class="result-item">
                  <div class="result-label">TelÃ©fono</div>
                  <div class="result-value">${escapeHtml(vm.phone)}</div>
                </div>
              ` : ""}

              <div class="result-item" style="grid-column: 1 / -1;">
                <div class="result-label">Transaction ID</div>
                <div class="result-value">${escapeHtml(vm.gatewayChargeId)}</div>
              </div>
            </div>

            <div class="result-actions">
              <button class="btn-primary" type="button" onclick="volverAlInicio()">Nueva operaciÃ³n</button>
              <button class="btn-soft" type="button" onclick="copyResultToClipboard()">Copiar detalle</button>
              <button class="btn-soft" type="button" onclick="toggleRawDetails()">Ver JSON</button>
            </div>

            <div id="rawDetails" style="display:none; margin-top:12px;">
              <pre style="
                white-space:pre-wrap;
                background:#f5f5f5;
                padding:12px;
                border-radius:12px;
                font-size:13px;
                overflow:auto;
                max-height:360px;
                border:1px solid var(--gris-200);
              ">${escapeHtml(JSON.stringify(rawResponse, null, 2))}</pre>
            </div>
          </div>
        `;
      }

      function toggleRawDetails() {
        const el = document.getElementById("rawDetails");
        if (!el) return;
        el.style.display = el.style.display === "block" ? "none" : "block";
      }

      async function copyResultToClipboard() {
        const obj = LS.getJson("payme_last_result", null);
        const text = obj ? JSON.stringify(obj, null, 2) : "Sin detalle.";
        try { await navigator.clipboard?.writeText(text); alert("Detalle copiado."); }
        catch { alert("No se pudo copiar."); }
      }

      function showStoredResultIfAny() {
        const obj = LS.getJson("payme_last_result", null);
        if (!obj?.data) return;

        if (obj.type === "success") {
          const vm = extractPaymentViewModel(obj.data, obj.ctx);
          renderPrettyResult(vm, obj.data, false);
          return;
        }

        const vm = {
          state: "ERROR",
          stateReason: "No se pudo completar el pago",
          merchantOperationNumber: obj?.ctx?.merchantOperationNumber || "â€”",
          amountFormatted: "â€”",
          methodLabel: "â€”",
          showCardFields: false,
          showYapeFields: false,
          brand: "â€”",
          maskedPan: "â€”",
          phone: "â€”",
          gatewayChargeId: obj?.ctx?.gatewayChargeId || "â€”",
        };
        renderPrettyResult(vm, obj.data, true);
      }

      /* History */
      function getSelectedMethods() {
        const map = [
          ["mp-tarjetas", "CARD"],
          ["mp-yape", "YAPE"],
          ["mp-qr", "QR"],
          ["mp-cuotealo", "CUOTEALO"],
          ["mp-pagoefectivo", "PAGOEFECTIVO"],
        ];
        const methods = [];
        for (const [id, code] of map) if ($(id)?.checked) methods.push(code);
        return methods;
      }

      function saveHistory() {
        LS.setJson("payme_historial", {
          clientId: els.clientId?.value || "",
          clientSecret: els.clientSecret?.value || "",
          merchantCode: els.merchantCode?.value || "",
          amount: els.amount?.value || "",
          currency: els.currency?.value || "604",
          methods: getSelectedMethods(),
        });
      }

      function loadHistory() {
        const h = LS.getJson("payme_historial", null);
        if (!h) return;

        if (els.clientId) els.clientId.value = h.clientId || "";
        if (els.clientSecret) els.clientSecret.value = h.clientSecret || "";
        if (els.merchantCode) els.merchantCode.value = h.merchantCode || "";
        if (els.amount && h.amount !== undefined) els.amount.value = h.amount;
        if (els.currency && h.currency !== undefined) els.currency.value = h.currency;

        $("mp-tarjetas") && ($("mp-tarjetas").checked = (h.methods || []).includes("CARD"));
        $("mp-yape") && ($("mp-yape").checked = (h.methods || []).includes("YAPE"));
        $("mp-qr") && ($("mp-qr").checked = (h.methods || []).includes("QR"));
        $("mp-cuotealo") && ($("mp-cuotealo").checked = (h.methods || []).includes("CUOTEALO"));
        $("mp-pagoefectivo") && ($("mp-pagoefectivo").checked = (h.methods || []).includes("PAGOEFECTIVO"));
      }

      /* Auth */
      function getCreds() {
        const clientId = (els.clientId?.value || "").trim() || DEFAULT_CREDS.clientId;
        const clientSecret = (els.clientSecret?.value || "").trim() || DEFAULT_CREDS.clientSecret;
        const merchantCode = (els.merchantCode?.value || "").trim() || DEFAULT_CREDS.merchantCode;
        return { clientId, clientSecret, merchantCode };
      }

      async function fetchJson(url, body, token) {
        const headers = { "Content-Type": "application/json" };
        if (token) headers.Authorization = `Bearer ${token}`;

        const r = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) {
          const msg = j?.error_description || j?.message || `HTTP ${r.status}`;
          throw new Error(msg);
        }
        return j;
      }

      async function obtenerAccessToken() {
        const { clientId, clientSecret } = getCreds();
        const cfg = state.cfg;

        const j = await fetchJson(cfg.tokenUrl, {
          action: "authorize",
          grant_type: "client_credentials",
          audience: cfg.audienceApi,
          client_id: clientId,
          client_secret: clientSecret,
          scope: "create:token post:charges offline_access",
        });

        return j.access_token;
      }

      async function obtenerNonce(token) {
        const { clientId } = getCreds();
        const cfg = state.cfg;

        const j = await fetchJson(
          cfg.nonceUrl,
          {
            action: "create.nonce",
            audience: cfg.audienceApi,
            client_id: clientId,
            scope: "post:charges",
          },
          token
        );

        return j.nonce;
      }

      /* Session timer */
      function getExpiryMinutes() {
        const v = parseInt(String(els.sessionMinutes?.value || "5"), 10);
        if (Number.isNaN(v)) return 5;
        return Math.min(Math.max(v, 1), 60);
      }

      function formatMMSS(ms) {
        const s = Math.ceil(ms / 1000);
        const m = Math.floor(s / 60);
        const r = s % 60;
        return `${String(m).padStart(2, "0")}:${String(r).padStart(2, "0")}`;
      }

      function stopSessionTimer() {
        if (state.sessionInterval) clearInterval(state.sessionInterval);
        state.sessionInterval = null;
      }

      function startSessionTimer(minutes) {
        stopSessionTimer();

        state.sessionTotalMs = minutes * 60 * 1000;
        state.sessionDeadline = Date.now() + state.sessionTotalMs;

        if (els.sessionControls) els.sessionControls.style.display = "flex";

        const tick = () => {
          const remaining = Math.max(0, state.sessionDeadline - Date.now());
          if (els.sessionCountdown) els.sessionCountdown.textContent = formatMMSS(remaining);

          const ratio = state.sessionTotalMs ? remaining / state.sessionTotalMs : 0;
          if (els.sessionBarFill) els.sessionBarFill.style.width = `${Math.max(0, Math.min(1, ratio)) * 100}%`;

          if (remaining <= 0) expirePaymentSession();
        };

        tick();
        state.sessionInterval = setInterval(tick, 250);
      }

      function restartSessionTimer() { startSessionTimer(getExpiryMinutes()); }

      function closeDemoContainers() {
        [els.demo, els.demoModal].forEach((el) => {
          if (!el) return;
          el.innerHTML = "";
          el.style.display = "none";
        });
      }

      function cleanupFlexUI() {
        if (state.pfTarget) {
          state.pfTarget.innerHTML = "";
          state.pfTarget.style.display = "none";
        }
        closeDemoContainers();
        if (els.loading) els.loading.style.display = "none";
        if (els.loadingModal) els.loadingModal.style.display = "none";
      }

      function expirePaymentSession() {
        stopSessionTimer();
        try { state.pf?.terminate?.(); } catch(e){ console.warn("pf.terminate failed", e); }
        cleanupFlexUI();

        if (els.modal && els.modal.style.display === "block") els.modal.style.display = "none";
        els.stage?.classList.remove("expandido");
        if (els.sessionControls) els.sessionControls.style.display = "none";

        const vm = {
          state: "EXPIRADO",
          stateReason: "Tiempo de espera",
          merchantOperationNumber: state.cancelCtx?.merchantOperationNumber || "â€”",
          amountFormatted: "â€”",
          methodLabel: "â€”",
          showCardFields: false,
          showYapeFields: false,
          brand: "â€”",
          maskedPan: "â€”",
          phone: "â€”",
          gatewayChargeId: state.cancelCtx?.gatewayChargeId || "â€”",
        };

        renderPrettyResult(vm, { message: "La transacciÃ³n venciÃ³ por tiempo de espera." }, true);
      }

      /* Callbacks */
      function responseCallback(response) {
        console.log("responseCallback", response);
        state.cancelCtx.gatewayChargeId = extractGatewayTransactionId(response);

        // âœ… Terminar op
        try { state.pf?.terminate?.(); } catch(e){ console.warn("pf.terminate failed", e); }

        cleanupFlexUI();
        saveLastGatewayResult("success", response);

        // Renderizar pantalla bonita (cuando anim ON o siempre segÃºn preferencia)
        const vm = extractPaymentViewModel(response, state.cancelCtx);
        renderPrettyResult(vm, response, false);
        showFinalAnimationOverlayIfEnabled();

        stopSessionTimer();
        if (els.sessionControls) els.sessionControls.style.display = "none";
      }

      function trackingCallback(trackdata) {
        console.log("trackingCallback", trackdata);
        const id = extractGatewayTransactionId(trackdata);
        if (id) state.cancelCtx.gatewayChargeId = id;
      }

      function onErrorCallback(error) {
        console.log("onErrorCallback", error);

        try { state.pf?.terminate?.(); } catch(e){ console.warn("pf.terminate failed", e); }

        cleanupFlexUI();
        saveLastGatewayResult("error", error);

        // Renderizar pantalla bonita de error (siempre)
        const vm = {
          state: "ERROR",
          stateReason: "No se pudo completar el pago",
          merchantOperationNumber: state.cancelCtx?.merchantOperationNumber || "â€”",
          amountFormatted: "â€”",
          methodLabel: "â€”",
          showCardFields: false,
          showYapeFields: false,
          brand: "â€”",
          maskedPan: "â€”",
          phone: "â€”",
          gatewayChargeId: state.cancelCtx?.gatewayChargeId || "â€”",
        };
        renderPrettyResult(vm, error, true);
        showFinalAnimationOverlayIfEnabled();

        stopSessionTimer();
        if (els.sessionControls) els.sessionControls.style.display = "none";
      }

      /* Loader */
      async function cargarFormulario(target, loadingEl) {
        hidePaymeOverlay();
        clearGatewayResults();

        if (loadingEl) loadingEl.style.display = "block";
        if (target) {
          target.style.display = "none";
          target.innerHTML = "";
        }

        try {
          const amountInput = els.amount?.value || "";
          const currency = els.currency?.value || "604";

          const amountToSend = amountToMinorUnits(amountInput, 2);
          if (amountToSend === "0") throw new Error("Ingresa un monto vÃ¡lido.");

          const token = await obtenerAccessToken();
          const nonce = await obtenerNonce(token);

          const { merchantCode } = getCreds();
          const merchantOperationNumber = generateMerchantOperationNumber();

          state.cancelCtx = { merchantCode, merchantOperationNumber, gatewayChargeId: null };

          const redirectBack = window.location.origin + window.location.pathname + "?payme_result=1";

          const payload = {
            action: "authorize",
            channel: "ecommerce",
            merchant_code: merchantCode,
            merchant_operation_number:   merchantOperationNumber/*"1924436726"*/,
            payment_method: { method_details: { redirect_url: redirectBack } },
            payment_details: {
              amount: amountToSend,
              currency,
              billing: {
                first_name: "Peter",
                last_name: "Kukurelo",
                email: "peter.kukurelo@pay-me.com",
                phone: { country_code: "+51", subscriber: "999999999" },
                location: {
                  line_1: "Av. Ejemplo 123",
                  line_2: "",
                  city: "Lima",
                  state: "Lima",
                  country: "Peru",
                },
              },
            },
          };



          const metodosUsuario = getSelectedMethods();
          console.log("MÃ©todos enviados:", metodosUsuario);

          await state.flexReady;
          if (typeof window.FlexPaymentForms !== "function") throw new Error("FlexPaymentForms no estÃ¡ disponible.");

          const pf = new window.FlexPaymentForms({
            nonce,
            payload,
            settings: {
              show_close_button: true,
              // âœ… CONTROLADO POR toggleAnimBtn
              display_result_screen: getDisplayResultScreenSetting(),
            },
            display_settings: { methods: metodosUsuario },
          });

          state.pf = pf;
          state.pfTarget = target;

          pf.init(target, responseCallback, trackingCallback, onErrorCallback);

          startSessionTimer(getExpiryMinutes());

          if (loadingEl) loadingEl.style.display = "none";
          if (target) target.style.display = "block";
        } catch (e) {
          console.error(e);
          alert(e?.message || "Error al cargar formulario.");
          if (loadingEl) loadingEl.style.display = "none";
        }
      }

      /* Public actions */
      function volverAlInicio() { hidePaymeOverlay(); window.location.reload(); }

      function abrirFormularioNormal(montoMinorUnits) {
        setAmountIfProvided(montoMinorUnits);
        saveHistory();
        cargarFormulario(els.demo, els.loading);
      }

      function abrirModal(montoMinorUnits) {
        setAmountIfProvided(montoMinorUnits);
        saveHistory();
        if (els.modal) els.modal.style.display = "block";
        cargarFormulario(els.demoModal, els.loadingModal);
      }

      function cerrarModal() {
        hidePaymeOverlay();
        stopSessionTimer();
        try { state.pf?.terminate?.(); } catch(e){ console.warn("pf.terminate failed", e); }
        cleanupFlexUI();
        if (els.sessionControls) els.sessionControls.style.display = "none";
        if (els.modal) els.modal.style.display = "none";
        els.stage?.classList.remove("expandido");
      }

      function abrirFormularioExpandido(montoMinorUnits) {
        els.stage?.classList.add("expandido");
        abrirFormularioNormal(montoMinorUnits);
      }

      /* Expose */
      window.volverAlInicio = volverAlInicio;
      window.abrirFormularioNormal = abrirFormularioNormal;
      window.abrirModal = abrirModal;
      window.cerrarModal = cerrarModal;
      window.abrirFormularioExpandido = abrirFormularioExpandido;

      window.toggleDarkMode = toggleDarkMode;
      window.restartSessionTimer = restartSessionTimer;
      window.onEnvChange = onEnvChange;
      window.toggleRawDetails = toggleRawDetails;
      window.copyResultToClipboard = copyResultToClipboard;

      window.toggleAnimMode = toggleAnimMode;
      window.updateAnimModeButton = updateAnimModeButton;

      /* Boot */
      document.addEventListener("DOMContentLoaded", async () => {
        cacheEls();
        await initEnvSelect();
        applySavedTheme();
        loadHistory();
        updateAnimModeButton();

        if (getQueryParam("payme_result") === "1") showStoredResultIfAny();
      });

    })();
  </script>
</body>
</html>


