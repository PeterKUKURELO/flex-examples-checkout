<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pago | Monark Perú</title>

  <!-- FlexPayment -->
  <script src="https://flex.alignet.io/flex-payment-forms.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://flex.alignet.io/main-flex-payment-forms.css" />

  <!-- Tipografía moderna -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* PALETA MONARK (WEB PERÚ) */
      --azul: #003057;
      --azul-hover: #00508A;
      --celeste: #00AEEF;
      --gris-900: #222222;
      --gris-600: #777777;
      --gris-200: #E5E5E5;
      --fondo: #F7F9FC;
      --blanco: #ffffff;

      --radius-lg:16px;
      --radius-xl:22px;
      --shadow-1:0 6px 18px rgba(0,0,0,.06);
      --shadow-2:0 14px 34px rgba(0,0,0,.12);
      --timing:.25s cubic-bezier(.2,.7,.2,1);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: Inter, Arial, sans-serif;
      background: var(--fondo);
      color:var(--gris-900);
    }

    /* Header */
    header{
      background:var(--blanco);
      height:72px;
      display:flex;
      align-items:center;
      padding:0 20px;
      box-shadow:0 1px 0 var(--gris-200);
      cursor:pointer;
    }
    header img{height:50px; width:auto}

    /* Layout asimétrico */
    .stage{
      display:grid;
      grid-template-columns: 430px 1fr;
      min-height:calc(100vh - 72px);
      position:relative;
    }
    .stage::before{
      content:"";
      position:absolute;
      inset:0 38% 0 0;
      background: linear-gradient(160deg, var(--azul), var(--celeste));
      clip-path: polygon(0 0, 100% 0, 86% 100%, 0% 100%);
      z-index:0;
    }

    /* Caja opciones */
    .options{
      grid-column:1/2;
      align-self:center;
      margin:40px;
      background:var(--blanco);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow-2);
      padding:28px;
      width:min(380px, 90%);
      z-index:2;
      position:relative;
    }
    .options h2{
      font-size:22px;
      font-weight:700;
      color:var(--azul);
      margin-bottom:6px;
    }
    .sub{font-size:13px; color:var(--gris-600); margin-bottom:18px}

    /* Botones */
    .stack{display:flex; flex-direction:column; gap:14px}
    .payment-option{
      --w:100%;
      width:var(--w);
      padding:14px 18px;
      font-weight:600;
      font-size:15px;
      background:var(--azul);
      color:#fff;
      border:none;
      border-radius:12px;
      box-shadow:var(--shadow-1);
      cursor:pointer;
      transition: transform var(--timing), background var(--timing), box-shadow var(--timing);
    }
    .payment-option:hover{
      background:var(--azul-hover);
      transform:translateY(-1px);
      box-shadow:0 8px 22px rgba(0,48,87,.25)
    }
    .payment-option:focus-visible{ outline:3px solid var(--celeste); outline-offset:2px}

    .payment-option:nth-child(1){ --w: 85% }
    .payment-option:nth-child(2){ --w: 65% }
    .payment-option:nth-child(3){ --w: 95% }

    /* Área formulario */
    .payment-wrap{
      grid-column:2/3;
      display:flex; align-items:center; justify-content:center;
      padding:50px;
      z-index:1;
    }
    .payment-container{
      width:min(950px, 100%);
      background:var(--blanco);
      border:1px solid var(--gris-200);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-1);
      padding:28px;
    }
    #loading{font-size:18px; color:#666; display:none}
    #demo{display:none; width:100%}
    #result{display:none; width:100%}
    #resultJson{
      background:#f5f5f5;
      border:1px solid var(--gris-200);
      border-radius:8px;
      padding:16px;
      font-family:'Courier New', monospace;
      font-size:12px;
      line-height:1.6;
      max-height:600px;
      overflow-y:auto;
      color:var(--gris-900);
      white-space:pre-wrap;
      word-wrap:break-word;
    }

    /* Modal */
    .modal{
      display:none; position:fixed; inset:0; z-index:1000;
      background:rgba(0,0,0,.55);
      backdrop-filter:blur(3px);
    }
    .modal-content{
      background:#fff; margin:6% auto; padding:26px;
      width:min(640px, 92%); border-radius:20px; position:relative;
      box-shadow:0 24px 60px rgba(0,0,0,.24);
    }
    .close{
      position:absolute; right:16px; top:12px; font-size:28px; color:#999; cursor:pointer; padding:2px 8px;
    }
    .close:hover{color:#000; background:#f3f3f3; border-radius:6px}

    /* Expandido */
    .stage.expandido::before{display:none}
    .stage.expandido .options{display:none}
    .stage.expandido .payment-wrap{grid-column:1/-1}
    .stage.expandido .payment-container{width:min(1080px, 96%)}

    /* Gateway botón interno */
    .payment-gateway-container .payment-methods-container .payment-method-wrapper 
    .payment-method-form-wrapper .payment-method-submit-btn button{
      background-color:var(--azul);
    }
    .payment-gateway-container .payment-methods-container .payment-method-wrapper 
    .payment-method-form-wrapper .payment-method-submit-btn button:hover{
      background-color:var(--azul-hover);
    }

    @media(max-width:980px){
      .stage{grid-template-columns:1fr}
      .stage::before{inset:0; clip-path: polygon(0 0, 100% 0, 100% 42%, 0% 70%)}
      .options{margin:28px auto 10px; width:min(500px, 92%)}
      .payment-wrap{padding:24px 16px}
    }
  </style>
</head>
<body>
  <header onclick="volverAlInicio()">
    <img src="https://www.monark.com.pe/static/themes/monark-pe/assets/img/logotipo512x350.png" alt="Monark Perú">
  </header>

  <main class="stage">
    <section class="options">
      <h2>Opciones de Pago</h2>
      <p class="sub">Selecciona tu método preferido</p>
      <div class="stack">
        <button class="payment-option" onclick="abrirFormularioNormal(200000)">Formulario Normal</button>
        
      </div>
    </section>

    <section class="payment-wrap">
      <div class="payment-container">
        <div id="loading">Cargando pasarela...</div>
        <div id="demo"></div>
        <div id="result">
          <h3 style="color:var(--azul);margin-bottom:16px">Respuesta del Pago</h3>
          <div id="resultJson"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarModal()">&times;</span>
      <h3 style="margin:4px 0 12px;color:#222">Pagar</h3>
      <div id="loadingModal">Cargando pasarela...</div>
      <div id="demoModal"></div>
    </div>
  </div>

  <script>
    function volverAlInicio(){window.location.reload();}

    function abrirFormularioExpandido(monto){
      const stage=document.querySelector('.stage');
      stage.classList.add('expandido');
      abrirFormularioNormal(monto);
    }

    async function obtenerAccessToken(){
      const r=await fetch("https://auth.alignet.io/token",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          action:"authorize",grant_type:"client_credentials",
          audience:"https://api.alignet.io",
          client_id:"P3Z0lVhF2MVDTP8jK4K04AQoYXunvw",
          client_secret:"uzTxF4Pfiz2sJgQxPDee0f4sBNR8jIvwzvVaTzwnR8PUP4mTI4IlFuuO4oBKGGJw",
          scope:"create:token post:charges offline_access"
        })
      }); 
      return (await r.json()).access_token;
    }

    async function obtenerNonce(token){
      const r=await fetch("https://auth.alignet.io/nonce",{
        method:"POST",
        headers:{"Content-Type":"application/json","Authorization":`Bearer ${token}`},
        body:JSON.stringify({
          action:"create.nonce",audience:"https://api.alignet.io",
          client_id:"P3Z0lVhF2MVDTP8jK4K04AQoYXunvw",
          scope:"post:charges"
        })
      }); 
      return (await r.json()).nonce;
    }

    async function cargarFormulario(target,loadingEl,monto){
      loadingEl.style.display="block"; 
      target.style.display="none"; 
      target.innerHTML="";

      try{
        const token=await obtenerAccessToken();
        const nonce=await obtenerNonce(token);
        const payload={
          action:"authorize",
          channel:"ecommerce",
          merchant_code:"4ac2203f-b44e-4695-a2cd-4fa258d57d9e",
          merchant_operation_number:Math.floor(Date.now()).toString().substring(7),
          payment_method:{},
          payment_details:{
            amount:Math.round(monto).toString(),
            currency:"604",
            billing:{
              first_name:"Cliente",
              last_name:"Monark",
              email:"cliente@monark.pe",
              phone:{country_code:"+51",subscriber:"999999999"},
              location:{line_1:"Av. Ejemplo 123",city:"Lima",state:"Lima",country:"Peru"}
            }
          }
        };

        const pf=new FlexPaymentForms({
          nonce,
          payload,
          settings:{show_close_button:false, display_result_screen:false },
          display_settings:{methods:['CARD', 'YAPE', 'QR', 'PAGOEFECTIVO'] }
        });

        function responseCallback(response){
          console.log("responseCallback", response);
          try{ pf.terminate(); }catch(e){ console.warn('pf.terminate failed', e) }

          // Hide any active payment UI
          const demo=document.getElementById("demo");
          const demoModal=document.getElementById("demoModal");
          const loading=document.getElementById("loading");
          const loadingModal=document.getElementById("loadingModal");
          if(demo) demo.style.display="none";
          if(demoModal) demoModal.style.display="none";
          if(loading) loading.style.display="none";
          if(loadingModal) loadingModal.style.display="none";

          // Show the result screen and render the JSON
          const result=document.getElementById("result");
          const resultJson=document.getElementById("resultJson");
          if(result && resultJson){
            resultJson.textContent = JSON.stringify(response, null, 2);
            result.style.display = "block";
            // expand layout for full-width result
            const stage=document.querySelector('.stage'); if(stage) stage.classList.add('expandido');
          }
        }

        pf.init(target,responseCallback,console.log,console.error);
        loadingEl.style.display="none"; 
        target.style.display="block";

      }catch(e){
        console.error(e);
        alert("Error al cargar formulario.");
        loadingEl.style.display="none";
      }
    }

    function abrirFormularioNormal(monto){
      // hide previous result if any
      const r=document.getElementById('result'); if(r) r.style.display='none';
      cargarFormulario(document.getElementById("demo"),document.getElementById("loading"),monto);
    }

    function abrirModal(monto){
      // hide previous result if any
      const r=document.getElementById('result'); if(r) r.style.display='none';
      document.getElementById("paymentModal").style.display="block";
      cargarFormulario(document.getElementById("demoModal"),document.getElementById("loadingModal"),monto);
    }

    function cerrarModal(){
      document.getElementById("paymentModal").style.display="none";
      document.getElementById("demoModal").innerHTML="";
    }
    
  </script>
</body>
</html>
